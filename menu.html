<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content='width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0'>
  <title>Demo</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/custom.css" rel="stylesheet">
  <link href="final.json">
</head>

<body>
  <!-- Login Modal -->
  <!--<div id="login-overlay login-modal" class="login-modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <div class="row">
          <div class="col-xs-12">
            
          </div>

        </div>
      </div>
    </div>
  </div>-->
  <!-- Login Modal End -->

  <!-- Header -->
  <nav class="navbar navbar-default">
    <div class="container">
      <!--       <a class="navbar-brand" href="#">Brand</a>-->
      <div class="input-group navbar-search header">
        <div class="row">
          <div class="form-group">
            <div class="col-xs-6">
              <select class="sto btn btn-danger" name="stolovi" id="sto">
              <option value="1">Sto 1</option>
              <option value="2">Sto 2</option>
              <option value="3">Sto 3</option>
              <option value="4">Sto 4</option>
              <option value="5">Sto 5</option>
            </select>
            </div>
            <!--<div class="col-xs-2 " id="search">
              <button class="btn btn-default">
                <span class="glyphicon glyphicon-search"></span>
              </button>
            </div>-->
            <div class="col-xs-6 ">
              <select class="konobar btn btn-info" name="konobar" id="kon">
              <option value="1">Pera</option>
              <option value="2">Mika</option>
              <option value="3">Laza</option>
            </select>
            </div>
          </div>
        </div>


        <!-- Search Polje -->
        <!--<input type="text" class="form-control" placeholder=""> <span class="input-group-btn">
        <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-search"></span></button>
        </span>-->
      </div>
      <!-- /input-group -->
      <!-- /.col-lg-6 -->
    </div>
  </nav>
  <!-- Header End -->
  <!-- Category -->
  <section class="main-section">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4">

          <!--												generator block         -->
          <ul class="accordion panel panel-default panel-group ">

          </ul>

        </div>
      </div>
    </div>
  </section>
  <div class="container" id="naruci-dug">
    <div class="row">
      <div class="col-xs-12 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3  col-lg-4 col-lg-offset-4">
        <button class="btn btn-danger btn-lg btn-block" id="naruci" onClick="Naruci();" data-toggle="modal">naruci</button>
      </div>
    </div>
  </div>

  <!-- Modal -->

  <div class="modal bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="potvrdiNarudzbinu">
    <div class="modal-dialog modal-sm" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="gridSystemModalLabel">Modal title</h4>
        </div>
        <div class="modal-body">
          <table id="narudzbina">

          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Izmeni</button>
          <button type="button" class="btn btn-success" onclick="Poruci();" data-dismiss="modal">Potvrdi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal End -->

  <!-- Category End -->

  <!-- Alert -->

  <!--<div class="alert alert-warning alert-dismissible" role="alert" style="    position: absolute;
    bottom: 0px;
    width: 90%;
    margin-left: 5%;">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <strong>Warning!</strong> Better check yourself, you're not looking too good.
  </div>-->

  <!-- Alert End -->

  <!-- Footer -->
  <!--<section class="form" style="display: none;">
    <form action="#" id="order" method="get">
      
      <button type="submit" class="order-submit"></button>

    </form>
  </section>-->

  <!--
	<section class="navbar navbar-default navbar-fixed-bottom">
		<div class="container-fluid">
			<div class="content">
				<ul class="nav nav-pills nav-justified">
						<li role="presentation" class="active"><a href="#">Home</a></li>
						<li role="presentation"><a href="#">Profile</a></li>
						<li role="presentation"><a href="#">Messages</a></li>
					</ul><a href="#" class="navbar-brand">Brand</a> </div>
		</div>
	</section>
-->

  <!-- End Footer -->
  <!-- Custom JavaScript -->
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <!--<script type="text/javascript" src="js/custom.js"></script>-->
  <script>
  var artikli = $.parseJSON('[{"tip":{"id_tipa":1,"tip":"hrana","kategorija":[{"id_kategorije":6,"kategorija":"Rostilj","id_tipa":1,"vrsta":[]},{"id_kategorije":7,"kategorija":"Riba","id_tipa":1,"vrsta":[]},{"id_kategorije":9,"kategorija":"Poslastice","id_tipa":1,"vrsta":[{"id_vrste":25,"vrsta":"kolaci","id_kategorije":9,"proizvod":[{"id_proizvoda":6,"proizvod":"baklava","cena":70,"id_vrste":25}]},{"id_vrste":26,"vrsta":"palacinke","id_kategorije":9,"proizvod":[{"id_proizvoda":7,"proizvod":"sa kremom","cena":100,"id_vrste":26}]}]}]}},{"tip":{"id_tipa":2,"tip":"pice","kategorija":[{"id_kategorije":3,"kategorija":"vina","id_tipa":2,"vrsta":[{"id_vrste":19,"vrsta":"bela vina","id_kategorije":3,"proizvod":[{"id_proizvoda":3,"proizvod":"grasevina","cena":500,"id_vrste":19}]},{"id_vrste":20,"vrsta":"crna vina","id_kategorije":3,"proizvod":[{"id_proizvoda":1,"proizvod":"vranac","cena":500,"id_vrste":20},{"id_proizvoda":2,"proizvod":"tamjanika","cena":500,"id_vrste":20}]}]},{"id_kategorije":5,"kategorija":"Sokovi","id_tipa":2,"vrsta":[{"id_vrste":23,"vrsta":"gazirani","id_kategorije":5,"proizvod":[{"id_proizvoda":4,"proizvod":"coca cola","cena":120,"id_vrste":23}]},{"id_vrste":24,"vrsta":"gusti","id_kategorije":5,"proizvod":[{"id_proizvoda":5,"proizvod":"borovnica","cena":120,"id_vrste":24}]}]}]}}]');
  var narudzbina = [];

  $(document).ready(function () {

  // item generator
  artikli.forEach(function (element) {
    var tip_class = "tip" + element.tip.id_tipa;
    $(".accordion").append('<li><button class="toggle btn btn-lg btn-primary btn-block tip" onclick="javascript:void(0);">' + element.tip.tip + '</button><ul class="inner panel panel-default ' + tip_class + '">');
    element.tip.kategorija.forEach(function (element) {
      var kat_class = "kat" + element.id_kategorije;
      $("." + tip_class).append('<li><button class="toggle btn btn-lg btn-primary btn-block kategorija" onclick="javascript:void(0);">' + element.kategorija + '</button><ul class="inner panel panel-default ' + kat_class + '">');
      element.vrsta.forEach(function (element) {
        var vr_class = "vr" + element.id_vrste;
        $("." + kat_class).append('<li><button class="toggle btn btn-lg btn-primary btn-block vrsta" onclick="javascript:void(0);">' + element.vrsta + '</button><ul class="inner panel panel-default ' + vr_class + '">');
        element.proizvod.forEach(function (element) {
          $("." + vr_class).append('<li><div class="input-group"><span class="input-group-btn"><button type="button" class="btn btn-primary btn-block btn-lg proizvod val">-</button></span><input type="text" id="' + element.proizvod + '" class="form-control btn btn-lg proizvod" value="' + element.proizvod + '" readonly><input type="number" class="narudzbina" hidden="hidden" id="' + element.id_proizvoda + '" value="0"><span class="input-group-btn"><button type="button" class="btn btn-primary btn-lg proizvod val" role="button">+</button> </span> ');
        });
      });
    });
    $(".accordion").append("</ul>");
  });

  // accordion
  $('.toggle').click(function (e) {
    e.preventDefault();
    var $this = $(this);
    if ($this.next().hasClass('show')) {
      $this.next().removeClass('show');
    } else {
      $this.parent().parent().find('li .inner').removeClass('show');
      $this.next().toggleClass('show');
    }
  });

  $(".val").click(function (e) {
    var $this = $(this);
    var plus = $this.parent().prev()[0];
    var minus = $this.parent().next().next()[0];
    var item_name = typeof ($this.parent().prev().prev()[0]) == "undefined" ? $this.parent().next()[0] : $this.parent().prev().prev()[0];
    var postoji = [];

    if (this.innerHTML == "+") {
      plus.value++;
      console.log(plus.value);
      item_name.value = item_name.id + " (" + plus.value + ")"
    } else if (this.innerHTML == "-") {
      if (minus.value > 1) {
        minus.value--;
        item_name.value = item_name.id + " (" + minus.value + ")";
        console.log(minus.id);
      } else {
        minus.value = 0;
        item_name.value = item_name.id;
      }
    } else {
      console.log("Error!");
    }
  });
});

function Naruci() {
  var naruci = $(".narudzbina");
  narudzbina = [];
  for (var i = 0; i < naruci.length; i++) {
    if (naruci[i].value > 0) {
      narudzbina.push({ "proizvod": $(naruci[i]).prev().attr('id'), "id_proizvoda": naruci[i].id, "kolicina": naruci[i].value });
    }
  }
  if (narudzbina != '') {
    $('.bs-example-modal-sm').modal('toggle');
    $('#narudzbina').html('<tr><th>proizvod</th><th>količina</th></tr>');
    var i = 0;
    narudzbina.forEach(function (element) {
      $('#narudzbina').append('<tr class="modal-pro"><td>' + element.proizvod + '</td><td><button class="btn btn-lg btn-info" id="'+ element.id_proizvoda +'" onclick="Promena(this);">-</button><span>' + element.kolicina + '</span><button class="btn btn-lg btn-info" id="'+ element.id_proizvoda +'" onclick="Promena(this);">+</button><button class="btn btn-lg btn-danger" id="'+ element.id_proizvoda +'" onclick="Izbaci(this);" style="float:right;">x</button></td></tr>');
      i++;
    })
  }
}

function Poruci() {
  // var naruci = $(".narudzbina");
  // var narudzbina = [];
  // for (var i = 0; i < naruci.length; i++) {
  //   if (naruci[i].value > 0) {
  //     narudzbina.push({ "idProizvoda": naruci[i].id, "Kolicina": naruci[i].value });
  //   }
  // }

  var idKonobara = $("#kon")[0].value;
  var idStola = $("#sto")[0].value;
  var porudzbenica = {
    "porudzbenica":
    {
      "idKonobara": idKonobara,
      "idStola": idStola
    },
    "detaljiPorudzbine": narudzbina
  };

  console.log(JSON.stringify(porudzbenica));
  if (porudzbenica != '') {
    $.ajax({
      // url: 'stolovi.html',
      type: 'post',
      dataType: 'json',
      success: function (data) {
        alert(data.msg);
      },
      data: JSON.stringify(porudzbenica)
    });
    // da resetuje vrednost polja, ali mora i da ažurira natpis i prikaže nulu
    for (var i = 0; i < naruci.length; i++) {
      naruci[i].value = 0;
      narudzbina = [];
    }
    // da resetuje natpis u elementu
    var temp = $('input.proizvod');
    for (var i = 0; i < temp.length; i++) {
      temp[i].value = temp[i].defaultValue;
    }
  }
}

function Promena(element) {
  $element = $(element);
  if (element.innerHTML == "+") {
    narudzbina[element.id].kolicina++;
    $element.prev()[0].innerHTML = narudzbina[element.id].kolicina;
  
  } else if (element.innerHTML == "-") {
    if (narudzbina[element.id].kolicina > 1) {
        narudzbina[element.id].kolicina--;
        $element.next()[0].innerHTML = narudzbina[element.id].kolicina;  
      }
  } else {
    console.log("Error!");
  }
  console.log(JSON.stringify(narudzbina));

}

function Izbaci(element) {
  var ovaj = element;
  // console.log(element);
  var polje = $("input#" + element.id);
  console.log(polje[0].value);
  // for (var i = 0; i < narudzbina.length; i++) {
  //   if (narudzbina[i].id_proizvoda == element.id) {
  //     // console.log("pre: " + polje[0].value);
  //     polje[0].value = 0;
  //     console.log("posle: " + polje[0].value);
  //     narudzbina.splice(narudzbina[i], 1);
  //     $(element).parent().parent().remove();

  //     // polje.prev()[0].value = polje.prev()[0].defaultValue;
    
  //   //http://prntscr.com/egt8p2
  //   }

// e ovde nikako ne može preko indeksa da se odradi... mora na drugi način
// ne nalazi 0ti element u osnovnim poljima kada je indeks nula

  narudzbina.forEach(function(element, i) {
    if (narudzbina[i].id_proizvoda == ovaj.id) {
      // console.log("pre: " + polje[0].value);
      polje[0].value = 0;
      console.log("posle: " + polje[0].value);
      narudzbina.splice(narudzbina[i], 1);
      $(ovaj).parent().parent().remove();
    }
  });


  

  

 console.log(narudzbina);

}

  </script>

</body>

</html>